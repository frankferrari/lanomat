<%# Logic: Identify leading game for special highlighting %>
<% is_leader = local_assigns[:game_iteration]&.index == 0 && game.votes_score > 0 %>
<%# Determine if user has voted for this game %>
<% voted = local_assigns[:voted] || local_assigns[:voted_game_ids]&.include?(game.id) %>

<div id="<%= dom_id game %>" class="relative group/card bg-slate-900 rounded-2xl border transition-all duration-300 p-5 flex flex-col justify-between <%= is_leader ? 'border-yellow-500/50 ring-1 ring-yellow-500/20 shadow-xl' : 'border-slate-800 hover:border-slate-700' %>">
  
  <%# Leader Badge %>
  <% if is_leader %>
    <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-yellow-500 text-slate-950 text-xs font-black uppercase px-3 py-0.5 rounded-full flex items-center gap-1 shadow-lg z-10">
      <%= heroicon "star", variant: :outline, options: { class: "w-3 h-3" } %>
      <span>Leading</span>
    </div>
  <% end %>

  <%# Game Information %>
  <div class="flex justify-between items-start">
    <div class="flex flex-col justify-center gap-2">
      <h3 class="font-bold text-md leading-tight group-hover/card:text-purple-400 transition-colors truncate">
        <%= game.name %>
      </h3>
      
      <% if game.tags.any? %>
        <div class="flex flex-wrap gap-1">
          <% game.tags.each do |tag| %>
            <span class="text-[10px] text-slate-400 font-semibold bg-slate-950/50 border border-slate-800 px-2 py-0.5 rounded-md uppercase tracking-wider"><%= tag.name %></span>
          <% end %>
        </div>
      <% end %>

      <% if game.price.present? || game.max_players.present? %>
        <div class="flex flex-wrap gap-4 items-center mt-1">
          <% if game.price.present? %>
            <div class="flex items-center gap-1.5 text-slate-400">
              <%= heroicon "tag", variant: :outline, options: { class: "w-3.5 h-3.5 text-purple-500" } %>
              <span class="text-xs font-medium"><%= game.price %></span>
            </div>
          <% end %>
          <% if game.max_players.present? %>
            <div class="flex items-center gap-1.5 text-slate-400">
              <%= heroicon "user-group", variant: :outline, options: { class: "w-3.5 h-3.5 text-blue-500" } %>
              <span class="text-xs font-medium"><%= game.max_players %> Max</span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Vote Controls %>
    <%# Vote Controls %>
    <% current_weight = current_user.votes.find_by(game: game)&.weight || 0 %>
    <div class="flex flex-col items-center bg-slate-950 border border-slate-800 p-2 rounded-xl min-w-14">
      <%= button_to vote_vote_path(game, direction: 'up', view: @view_mode || 'grid'), 
          method: :post, 
          class: "p-1 transition-colors group/up #{voted ? 'text-green-400' : 'text-slate-400 hover:text-green-400'}" do %>
        <%= heroicon "chevron-up", variant: voted ? :solid : :outline, 
            options: { class: "w-5 h-5 group-active/up:scale-90 transition-transform" } %>
      <% end %>
      
      <div class="flex flex-col items-center gap-0">
        <% 
          vote_color = case current_weight
                       when 0 then "text-white"
                       when 1 then "text-green-400"
                       when 2 then "text-lime-400"
                       when 3 then "text-yellow-400"
                       when 4 then "text-orange-400"
                       else "text-red-500"
                       end
        %>
        <span class="text-xl font-black min-w-6 text-center leading-none <%= vote_color %>">
          <%= game.votes_score %>
        </span>
      </div>
      
      <%= button_to vote_vote_path(game, direction: 'down', view: @view_mode || 'grid'), 
          method: :post, 
          class: "p-1 text-slate-400 hover:text-red-400 transition-colors group/down" do %>
        <%= heroicon "chevron-down", variant: :outline, 
            options: { class: "w-5 h-5 group-active/down:scale-90 transition-transform" } %>
      <% end %>
    </div>
  </div>
</div>
