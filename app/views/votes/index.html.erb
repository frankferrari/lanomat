<%= turbo_stream_from "games" %>

<%# Wheel of Fortune overlay container - broadcasts will replace this %>
<%= render Current.game_session.wheel_active? ? "wheel/overlay" : "wheel/empty",
    game_session: Current.game_session,
    games: Current.game_session.wheel_games_data,
    proportional: Current.game_session.wheel_proportional?,
    start_at: Current.game_session.wheel_start_at,
    winner_id: Current.game_session.wheel_winner_id,
    spin_id: Current.game_session.wheel_spin_id %>

<div class="min-h-screen bg-slate-950 text-slate-100 font-sans selection:bg-purple-500/30 pb-20">
    <%= render "shared/header" %>

    <main class="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
        <turbo-frame id="votes_view" class="block space-y-6" data-controller="view-mode" data-view-mode-current-value="<%= @view_mode %>">
            <!-- Title and View Toggle Row -->
            <div class="flex items-center justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <%= heroicon "squares-2x2", variant: :outline, options: { class: "w-6 h-6 text-purple-500" } %>
                        Voting Room
                    </h2>
                      <%= render "bonus_counter" %>
                </div>

                <div class="flex items-center gap-2">
                    <%# Spin the Wheel button (host only, when enabled) %>
                    <% if policy(Current.game_session).update? && Current.game_session.wheel_can_spin? %>
                        <%= button_to spin_wheel_path,
                            method: :post,
                            class: "flex items-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white rounded-lg text-sm font-bold transition-all shadow-lg shadow-purple-500/20",
                            title: "Spin the Wheel" do %>
                            <%= heroicon "arrow-path", variant: :outline, options: { class: "w-4 h-4" } %>
                            <span>Spin Wheel</span>
                        <% end %>
                    <% end %>

                    <% if policy(Current.game_session).reset? %>
                        <%= button_to reset_votes_path, 
                            method: :post,
                            class: "flex items-center gap-1.5 px-3 py-1.5 bg-red-600/20 border border-red-500/50 text-red-400 hover:bg-red-600/40 hover:text-red-300 rounded-lg text-sm font-medium transition-all",
                            title: "Reset All Votes",
                            data: { turbo_confirm: "Are you sure you want to reset all votes? This cannot be undone." } do %>
                            <%= heroicon "arrow-path", variant: :outline, options: { class: "w-4 h-4" } %>
                            <span>Reset Votes</span>
                        <% end %>
                    <% end %>

                    <div class="flex items-center bg-slate-900 border border-slate-800 rounded-lg p-1">
                        <%= link_to votes_path(view: "grid", tag: params[:tag]), 
                            class: "p-1 px-2 rounded-md transition-colors #{@view_mode == 'grid' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'}",
                            title: "Grid View",
                            data: { turbo_action: "replace", action: "click->view-mode#save", view_mode_value_param: "grid" } do %>
                            <%= heroicon "squares-2x2", variant: :outline, options: { class: "w-5 h-5" } %>
                        <% end %>
                        <%= link_to votes_path(view: "list", tag: params[:tag]), 
                            class: "p-1 px-2 rounded-md transition-colors #{@view_mode == 'list' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'}",
                            title: "List View",
                            data: { turbo_action: "replace", action: "click->view-mode#save", view_mode_value_param: "list" } do %>
                            <%= heroicon "bars-3", variant: :outline, options: { class: "w-5 h-5" } %>
                        <% end %>
                    </div>
                </div>
            </div>

            <%= render "votes/previous_game" %>

            <div id="countdown_status">
                <%= render "votes/countdown_badge", game_session: Current.game_session %>
            </div>

            <!-- Tag-based Filtering Tabs -->
            <div class="flex flex-wrap gap-2">
                <%= link_to "ALL", votes_path(tag: 'All', view: @view_mode), 
                    class: "px-3 py-1 rounded-full text-[10px] font-bold tracking-wider border transition-all #{ params[:tag].blank? || params[:tag] == 'All' ? 'bg-purple-600 border-purple-400 text-white' : 'bg-slate-900 border-slate-700 text-slate-400' }",
                    data: { turbo_action: "replace" } %>
                
                <% Tag.order(:name).each do |tag| %>
                    <%= link_to tag.name.upcase, votes_path(tag: tag.name, view: @view_mode), 
                        class: "px-3 py-1 rounded-full text-[10px] font-bold tracking-wider border transition-all #{ params[:tag] == tag.name ? 'bg-purple-600 border-purple-400 text-white' : 'bg-slate-900 border-slate-700 text-slate-400' }",
                        data: { turbo_action: "replace" } %>
                <% end %>
            </div>

            <!-- Games Display Container -->
            <div id="games_container" class="transition-all duration-300">
                <% if @view_mode == 'grid' %>
                    <%= render "votes/settings_cards" %>
                    <div id="games_grid" data-controller="sortable-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <%= render partial: "votes/card_grid", collection: @games, as: :game, locals: { voted_game_ids: @voted_game_ids } %>
                        <% if @games.empty? %>
                            <div class="col-span-full py-20 text-center text-slate-500 border-2 border-dashed border-slate-800 rounded-3xl italic">
                                No games found.
                            </div>
                        <% end %>
                    </div>
                <% else %>
                    <div class="flex flex-col lg:flex-row gap-8 items-start">
                        <div id="games_list" data-controller="sortable-list" class="flex-1 flex flex-col gap-2 w-full">
                            <%= render partial: "votes/card_list", collection: @games, as: :game, locals: { voted_game_ids: @voted_game_ids } %>
                            <% if @games.empty? %>
                                <div class="py-20 text-center text-slate-500 border-2 border-dashed border-slate-800 rounded-3xl italic">
                                    No games found.
                                </div>
                            <% end %>
                        </div>
                        
                        <aside class="w-full lg:w-[200px] shrink-0">
                            <%= render "votes/settings_cards", vertical: true %>
                        </aside>
                    </div>
                <% end %>
            </div>
        </turbo-frame>
    </main>
</div>
