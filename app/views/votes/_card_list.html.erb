<%# Determine if user has voted for this game %>
<% voted = local_assigns[:voted] || local_assigns[:voted_game_ids]&.include?(game.id) %>

<%# Calculate opacity for negative scores: 100% at 0, gradually fade to 20% at -5 and below %>
<% 
  card_opacity = if game.votes_score >= 0
                   1.0
                 else
                   # Map -1 to 0.84, -2 to 0.68, -3 to 0.52, -4 to 0.36, -5+ to 0.2
                   [0.2, 1.0 + (game.votes_score * 0.16)].max
                 end
%>

<div id="<%= dom_id game, :list %>" 
     data-sortable-list-target="item"
     data-score="<%= game.votes_score %>"
     data-name="<%= game.name %>"
     style="opacity: <%= card_opacity %>;"
     class="group/card bg-slate-900 rounded-lg border transition-all duration-300 p-3 flex items-center gap-4 border-slate-800 hover:border-slate-700 data-[leader=true]:border-yellow-500/50 data-[leader=true]:ring-1 data-[leader=true]:ring-yellow-500/20">
  
  <%# Game Information %>
  <div class="flex-1 min-w-0 flex flex-col justify-center gap-1">
    <h3 class="font-bold text-md leading-tight group-hover/card:text-purple-400 transition-colors truncate flex items-center gap-2">
      <%= game.name %>
      <%# Leader badge rendered dynamically by Stimulus %>
    </h3>
    
    <div class="flex flex-wrap items-center gap-3">
      <% if game.tags.any? %>
        <div class="flex flex-wrap gap-1">
          <% game.tags.each do |tag| %>
            <span class="<%= tag_color_classes(tag) %> font-semibold border px-2 py-0.5 rounded-md uppercase tracking-wider text-[10px]"><%= tag.name %></span>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Vote Controls %>
  <% current_weight = current_user.votes.find_by(game: game)&.weight || 0 %>
  <div class="shrink-0 flex flex-row items-center bg-slate-950 border border-slate-800 py-1 px-3 rounded-xl gap-2 sm:gap-3">
    <%= button_to vote_vote_path(game, direction: 'up', view: @view_mode || 'list'), 
        method: :post, 
        class: "p-1 transition-colors group/up #{voted ? 'text-green-400' : 'text-slate-400 hover:text-green-400'}" do %>
      <%= heroicon "chevron-up", variant: voted ? :solid : :outline, options: { class: "w-4 h-4 sm:w-5 sm:h-5 group-active/up:scale-90 transition-transform" } %>
    <% end %>
    
    <div class="flex flex-col items-center min-w-[1.5rem] sm:min-w-[2rem]">
      <% 
        vote_color = if current_weight < 0
                       "text-red-500"
                     else
                       case current_weight
                       when 0 then "text-white"
                       when 1 then "text-green-400"
                       when 2 then "text-lime-400"
                       when 3 then "text-yellow-400"
                       when 4 then "text-orange-400"
                       else "text-red-500"
                       end
                     end
      %>
      <span id="<%= dom_id game, :score_list %>" class="text-sm sm:text-base font-black text-center <%= vote_color %>">
        <%= game.votes_score %>
      </span>
    </div>
    
    <% can_downvote = Current.game_session.allow_downvotes? || current_weight > 0 %>
    <%= button_to vote_vote_path(game, direction: 'down', view: @view_mode || 'list'), 
        method: :post, 
        disabled: !can_downvote,
        class: "p-1 transition-colors group/down #{can_downvote ? 'text-slate-400 hover:text-red-400' : 'text-slate-700 cursor-not-allowed'}" do %>
      <%= heroicon "chevron-down", variant: :outline, options: { class: "w-4 h-4 sm:w-5 sm:h-5 #{can_downvote ? 'group-active/down:scale-90 transition-transform' : ''}" } %>
    <% end %>
  </div>
</div>
